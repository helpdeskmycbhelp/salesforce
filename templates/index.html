<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Available Units – Public (Salesforce Sandbox)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Your custom CSS -->
  <link rel="stylesheet" href="/static/site.css">
</head>
<body class="bg-page">
<header class="container py-4">
  <div class="d-flex flex-wrap gap-3 justify-content-between align-items-end">
    <div>
      <h1 class="page-title mb-1">Available Units</h1>
      <p class="text-muted small m-0">Live from Salesforce (Sandbox). Data is cached briefly for performance.</p>
    </div>
    <div class="d-flex gap-2">
      <button id="btn-refresh" class="btn btn-outline-primary">
        <span class="spinner-border spinner-border-sm me-2 d-none" id="spin-refresh" role="status" aria-hidden="true"></span>
        Refresh
      </button>
    </div>
  </div>
</header>

<main class="container pb-5">
  <div class="card shadow-sm card-surface">
    <div class="card-body">
      <!-- Controls / status line -->
      <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
        <div class="small text-muted">
          <span id="hint" class="me-2"></span>
          <span id="recordCount" class="badge rounded-pill text-bg-light d-none"></span>
        </div>
        <div id="msg" class="small text-danger"></div>
      </div>

      <div class="table-responsive table-scroll">
        <table class="table table-sm align-middle" id="units-table">
          <thead class="table-head">
            <tr id="head-row"></tr>
          </thead>
          <tbody id="rows">
            <tr><td class="text-muted p-4">Loading…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="empty-state d-none" id="empty">
        <img alt="" src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f4dd.svg" class="empty-emoji">
        <p class="empty-text">No records to display.</p>
      </div>
    </div>
  </div>
</main>

<footer class="container py-4 small text-muted">
  <span>Powered by Salesforce REST API • Cached for quick loading</span>
</footer>

<script>
/* ----------- Columns to display: [Label, FieldAPIName, typeHint?] ----------- */
const COLS = [
  ["Id","Id"],
  ["Title","Name"],
  ["Status","Status__c","badge"],
  ["Category","Category__c"],
  ["Community","Community__c"],
  ["Project","Project_Name__c"],
  ["Unit Type","Unit_Type__c"],
  ["View","View__c"],
  ["Beds","Beds__c","chip"],
  ["Baths","Baths__c","chip"],
  ["BUA (sqft)","Built_up_Area__c","num"],
  ["Price","Price__c","currency"],
  ["Price/ft²","Price_Per_SqFt__c","currency"],
  ["Rent Freq","Rent_Frequency__c"],
  ["Ownership","Ownership__c"],
  ["Tenure","Tenure__c"],
  ["Furnished","Furnished__c","badge-gray"],
  ["Parking","Parking__c","badge-gray"],
  ["Emirate","Emirate__c"],
  ["City","City__c"],
  ["Ref #","Reference_No__c","mono"],
  ["Trakheesi #","Trakheesi_Permit_No__c","mono"],
  ["Created","CreatedDate","date"],
  ["Last Modified","LastModifiedDate","date"],
];

function renderHeader(){
  document.getElementById("head-row").innerHTML =
    COLS.map(([label]) => `<th scope="col">${label}</th>`).join("");
}

function fmtBoolean(v){
  if (v === true)  return '<span class="badge text-bg-success-soft">Yes</span>';
  if (v === false) return '<span class="badge text-bg-danger-soft">No</span>';
  return "";
}
function fmtNumber(v){
  if (v === null || v === undefined || v === "") return "";
  const n = Number(v);
  if (Number.isNaN(n)) return v;
  return new Intl.NumberFormat().format(n);
}
function fmtCurrency(v){
  if (v === null || v === undefined || v === "") return "";
  const n = Number(v);
  if (Number.isNaN(n)) return v;
  return new Intl.NumberFormat(undefined, { maximumFractionDigits: 2 }).format(n);
}
function fmtDate(v){
  if (!v) return "";
  // Salesforce ISO format — display local date/time short
  const d = new Date(v);
  if (isNaN(d.getTime())) return v;
  return d.toLocaleString();
}
function badge(text, tone="primary"){
  if (!text) return "";
  return `<span class="badge text-bg-${tone}-soft">${escapeHtml(String(text))}</span>`;
}
function chip(text){
  if (!text) return "";
  return `<span class="chip">${escapeHtml(String(text))}</span>`;
}
function mono(text){
  if (!text) return "";
  return `<span class="mono">${escapeHtml(String(text))}</span>`;
}
function escapeHtml(s){
  const t = document.createElement("textarea");
  t.textContent = s;
  return t.innerHTML;
}

function renderCell(rec, field, hint){
  const val = rec[field];
  switch (hint){
    case "badge":      return badge(val, "info");
    case "badge-gray": return badge(val, "muted");
    case "chip":       return chip(val);
    case "num":        return fmtNumber(val);
    case "currency":   return fmtCurrency(val);
    case "date":       return fmtDate(val);
    case "mono":       return mono(val);
    default:
      if (val === true || val === false) return fmtBoolean(val);
      return val ?? "";
  }
}

async function loadUnits(force=false){
  renderHeader();
  const rows  = document.getElementById("rows");
  const msg   = document.getElementById("msg");
  const hint  = document.getElementById("hint");
  const empty = document.getElementById("empty");
  const count = document.getElementById("recordCount");
  const spin  = document.getElementById("spin-refresh");

  msg.textContent = "";
  hint.textContent = "";
  empty.classList.add("d-none");
  count.classList.add("d-none");
  rows.innerHTML = `<tr><td colspan="${COLS.length}" class="py-4">Loading…</td></tr>`;
  spin.classList.remove("d-none");

  try{
    const url = "/api/units" + (force ? "?refresh=1" : "");
    const r = await fetch(url);
    const data = await r.json();
    if (!r.ok || !data.ok) throw new Error(typeof data.error === "string" ? data.error : JSON.stringify(data.error));

    if (!data.records?.length){
      rows.innerHTML = "";
      empty.classList.remove("d-none");
      hint.textContent = data.fromCache ? `served from cache (ttl ${data.cacheTtl}s)` : `fresh from Salesforce (cached ${data.cacheTtl}s)`;
      return;
    }

    // Build rows
    rows.innerHTML = data.records.map(rec => `
      <tr>
        ${COLS.map(([_, f, h]) => `<td>${renderCell(rec, f, h)}</td>`).join("")}
      </tr>
    `).join("");

    // Status line
    hint.textContent = data.fromCache
      ? `served from cache (ttl ${data.cacheTtl}s)`
      : `fresh from Salesforce (cached ${data.cacheTtl}s)`;
    count.textContent = `${data.totalSize} records`;
    count.classList.remove("d-none");
  }catch(e){
    msg.textContent = "Error: " + e.message;
    rows.innerHTML = `<tr><td colspan="${COLS.length}" class="text-danger py-4">Failed to load.</td></tr>`;
  }finally{
    spin.classList.add("d-none");
  }
}

/* Auto-load immediately when the page opens */
window.addEventListener("DOMContentLoaded", () => {
  loadUnits();   // load immediately when page opens
});

/* Manual refresh */
document.getElementById("btn-refresh").addEventListener("click", () => loadUnits(true));
</script>
</body>
</html>
