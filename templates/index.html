<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Available Units ‚Äì Public (Salesforce Sandbox)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- optional custom styles (create static/site.css in your repo) -->
  <link rel="stylesheet" href="/static/site.css">
  <style>
    /* Minimal inline styles in case /static/site.css isn't present */
    :root{
      --bg:#f6f8fb; --border:#e9ecf1; --muted:#6c757d;
    }
    body{ background:var(--bg); }
    .card{ border:1px solid var(--border); border-radius:16px; }
    .table-scroll{ max-height:70vh; overflow:auto; border:1px solid var(--border); border-radius:12px }
    thead th{ position:sticky; top:0; background:#fff; z-index:1; border-bottom:1px solid var(--border) }
    .badge.text-bg-info-soft{ color:#0aa2c0; background:#e6f7fb; border:1px solid #d4eef7 }
    .chip{ display:inline-block; padding:.15rem .5rem; border-radius:999px; background:#eef2f7; border:1px solid var(--border); font-size:.8rem }
    .empty-state{ display:flex; flex-direction:column; align-items:center; color:var(--muted); padding:2rem 0 }
  </style>
</head>
<body>
<header class="container py-4">
  <div class="d-flex flex-wrap gap-3 justify-content-between align-items-end">
    <div>
      <h1 class="h4 mb-1">Available Units</h1>
      <p class="text-muted small m-0">Live from Salesforce (Sandbox). Data is cached briefly for performance.</p>
    </div>
    <button id="btn-refresh" class="btn btn-outline-primary">
      <span class="spinner-border spinner-border-sm me-2 d-none" id="spin-refresh" role="status" aria-hidden="true"></span>
      Refresh
    </button>
  </div>
</header>

<main class="container pb-5">
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
        <div class="small text-muted">
          <span id="hint" class="me-2"></span>
          <span id="recordCount" class="badge rounded-pill text-bg-light d-none"></span>
        </div>
        <div id="msg" class="small text-danger"></div>
      </div>

      <div class="table-responsive table-scroll">
        <table class="table table-sm align-middle" id="units-table">
          <thead><tr id="head-row"></tr></thead>
          <tbody id="rows"><tr><td class="text-muted p-4">Loading‚Ä¶</td></tr></tbody>
        </table>
      </div>

      <div class="empty-state d-none" id="empty">
        <div class="mb-2">üóÇÔ∏è</div>
        <div>No records to display.</div>
      </div>
    </div>
  </div>
</main>

<footer class="container py-4 small text-muted">
  Powered by Salesforce REST API ‚Ä¢ Cached for quick loading
</footer>

<script>
/* ---------- Columns (label, fieldExpr, renderHint?) ----------
   Use "|" in fieldExpr for fallbacks. Use dotted paths for lookups.
-------------------------------------------------------------- */
const COLS = [
  ["Title",            "Name"],
  ["Reference Number", "Reference_Number__c"],
  ["Record Type",      "RecordTypeId"],
  ["Unit Type",        "Unit_Type__c"],
  ["Beds",             "Beds__c", "chip"],
  ["Floor",            "Floor__c"],
  ["Unit No",           "Unit_No__c"],
  ["Built-up Area",    "Built_up_Area__c", "num"],
  ["Booking Status",   "Booking_Status__c|Status__c", "badge"],
  ["Price",            "Price__c", "currency"],
  ["Community",        "Community__c"],
  ["Building",         "Building__r.Name|Building_Name__c"]
];

/* ---------- table header ---------- */
function renderHeader(){
  document.getElementById("head-row").innerHTML =
    COLS.map(([label]) => `<th scope="col">${label}</th>`).join("");
}

/* ---------- utils ---------- */
function escapeHtml(s){ const t=document.createElement("textarea"); t.textContent=s; return t.innerHTML; }
function getByPath(obj, path){
  return path.split('.').reduce((o,k)=> (o && o[k]!==undefined) ? o[k] : undefined, obj);
}
function getValueWithFallback(rec, expr){
  for (const p of expr.split("|")){
    const v = p.includes(".") ? getByPath(rec, p) : rec[p];
    if (v !== undefined && v !== null && v !== "") return v;
  }
  return "";
}

/* ---------- formatters ---------- */
function fmtBoolean(v){ if(v===true) return '<span class="badge text-bg-success">Yes</span>'; if(v===false) return '<span class="badge text-bg-danger">No</span>'; return ""; }
function fmtNumber(v){ if(v===null||v===undefined||v==="") return ""; const n=Number(v); return Number.isNaN(n)? v : new Intl.NumberFormat().format(n); }
function fmtCurrency(v){ if(v===null||v===undefined||v==="") return ""; const n=Number(v); return Number.isNaN(n)? v : new Intl.NumberFormat(undefined,{maximumFractionDigits:2}).format(n); }
function badge(text){ if(!text) return ""; return `<span class="badge text-bg-info-soft">${escapeHtml(String(text))}</span>`; }
function chip(text){ if(!text) return ""; return `<span class="chip">${escapeHtml(String(text))}</span>`; }

function renderCell(rec, fieldExpr, hint){
  const val = getValueWithFallback(rec, fieldExpr);
  switch(hint){
    case "badge":    return badge(val);
    case "chip":     return chip(val);
    case "num":      return fmtNumber(val);
    case "currency": return fmtCurrency(val);
    default:
      if(val===true || val===false) return fmtBoolean(val);
      return val ?? "";
  }
}

/* ---------- load units (robust JSON handling) ---------- */
async function loadUnits(force=false){
  renderHeader();
  const rows  = document.getElementById("rows");
  const msg   = document.getElementById("msg");
  const hint  = document.getElementById("hint");
  const empty = document.getElementById("empty");
  const count = document.getElementById("recordCount");
  const spin  = document.getElementById("spin-refresh");

  msg.textContent = ""; hint.textContent=""; empty.classList.add("d-none"); count.classList.add("d-none");
  rows.innerHTML = `<tr><td colspan="${COLS.length}" class="py-4">Loading‚Ä¶</td></tr>`;
  spin?.classList.remove("d-none");

  try{
    const r = await fetch("/api/units" + (force ? "?refresh=1" : ""));
    const ct = r.headers.get("content-type") || "";
    const data = ct.includes("application/json") ? await r.json() : { ok:false, error: await r.text() };

    if (!r.ok || !data.ok) throw new Error(typeof data.error === "string" ? data.error : JSON.stringify(data.error));

    if (!data.records?.length){
      rows.innerHTML = "";
      empty.classList.remove("d-none");
      hint.textContent = data.fromCache ? `served from cache (ttl ${data.cacheTtl}s)` : `fresh from Salesforce (cached ${data.cacheTtl}s)`;
      return;
    }

    rows.innerHTML = data.records.map(rec => `
      <tr>
        ${COLS.map(([_, fieldExpr, hint]) => `<td>${renderCell(rec, fieldExpr, hint)}</td>`).join("")}
      </tr>
    `).join("");

    hint.textContent = data.fromCache
      ? `served from cache (ttl ${data.cacheTtl}s)`
      : `fresh from Salesforce (cached ${data.cacheTtl}s)`;
    count.textContent = `${data.totalSize} records`;
    count.classList.remove("d-none");
  }catch(e){
    msg.textContent = "Error: " + e.message;
    rows.innerHTML = `<tr><td colspan="${COLS.length}" class="text-danger py-4">Failed to load.</td></tr>`;
  }finally{
    spin?.classList.add("d-none");
  }
}

/* auto-load on open */
window.addEventListener("DOMContentLoaded", () => { loadUnits(); });
/* manual refresh */
document.getElementById("btn-refresh").addEventListener("click", () => loadUnits(true));
</script>
</body>
</html>
